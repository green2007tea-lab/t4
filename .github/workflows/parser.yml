name: Steam Parser - 20 Workers

on:
  workflow_dispatch:
  # schedule:
  #   - cron: '0 */5 * * *'  # Каждые 2 часа

jobs:
  parse:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # Максимум 45 минут (с учетом задержки до 3 минут)
    continue-on-error: true  # Не останавливать другие воркеры при ошибке
    strategy:
      matrix:
        worker_id: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20]
      max-parallel: 20  # Все воркеры одновременно
      fail-fast: false  # Не останавливать при ошибке
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install Python dependencies
      run: pip install -r requirements.txt
    
    - name: Random delay to avoid API rate limit
      run: |
        DELAY=$((RANDOM % 180))
        echo "⏳ Задержка $DELAY секунд для воркера ${{ matrix.worker_id }}"
        sleep $DELAY
    
    - name: Get data from Google Sheets
      env:
        GOOGLE_SHEETS_CREDENTIALS: ${{ secrets.GOOGLE_SHEETS_CREDENTIALS }}
      run: python read_sheets.py
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Install Node dependencies
      run: npm install
    
    - name: Run parser (Worker ${{ matrix.worker_id }}/20)
      env:
        API_TG: ${{ secrets.API_TG }}
        ID: ${{ secrets.ID }}
        WORKER_ID: ${{ matrix.worker_id }}
        TOTAL_WORKERS: 20
      run: node parser.js
